#!/usr/bin/env node

/**
 * This script sets up the .env.local file with credentials from local Supabase
 * Run automatically after `supabase start`
 */

import { execSync } from 'child_process';
import fs from 'fs';
import path from 'path';
import { fileURLToPath } from 'url';

const __filename = fileURLToPath(import.meta.url);
const __dirname = path.dirname(__filename);

/**
 * Parse an existing .env file and return non-matching variables.
 * @param {string} filePath - Path to the env file
 * @param {string[]} prefixesToSkip - Variable prefixes to exclude (will be regenerated)
 * @returns {Record<string, string>} - Preserved variables
 */
function parseAndPreserveEnvVars(filePath, prefixesToSkip) {
  const preserved = {};
  if (!fs.existsSync(filePath)) return preserved;

  const content = fs.readFileSync(filePath, 'utf-8');
  for (const line of content.split('\n')) {
    const trimmed = line.trim();
    // Skip comments and empty lines
    if (!trimmed || trimmed.startsWith('#')) continue;
    // Skip variables matching prefixes (we'll regenerate those)
    if (prefixesToSkip.some(prefix => trimmed.startsWith(prefix))) continue;
    // Parse and preserve other variables
    const match = trimmed.match(/^([^=]+)=(.*)$/);
    if (match) {
      preserved[match[1]] = match[2];
    }
  }
  return preserved;
}

console.log('Setting up local environment variables...\n');

try {
  // Get Supabase status
  const statusOutput = execSync('supabase status --output json', { encoding: 'utf-8' });
  // Extract just the JSON object (ignore any warning lines after)
  const jsonMatch = statusOutput.match(/^\{[\s\S]*?\n\}/m);
  if (!jsonMatch) {
    throw new Error('Could not parse Supabase status output');
  }
  const status = JSON.parse(jsonMatch[0]);

  // Get the API URL, anon key, and service role key from the object
  const apiUrl = status.API_URL;
  const anonKey = status.ANON_KEY;
  const serviceRoleKey = status.SERVICE_ROLE_KEY;

  if (!apiUrl || !anonKey) {
    console.error('‚ùå Could not find Supabase API URL or anon key');
    console.log('Make sure Supabase is running: supabase status');
    process.exit(1);
  }

  if (!serviceRoleKey) {
    console.error('‚ùå Could not find Supabase service role key');
    console.log('Make sure Supabase is running: supabase status');
    process.exit(1);
  }

  // Create or update .env.local file
  const envPath = path.join(process.cwd(), '.env.local');

  // Preserve existing non-Supabase variables if file exists
  const existingVars = parseAndPreserveEnvVars(envPath, ['NEXT_PUBLIC_SUPABASE_']);

  // Build the new content
  let envContent = `# Local Supabase Configuration
# This file is auto-generated by scripts/setup-local-env.js
# Do not commit this file

NEXT_PUBLIC_SUPABASE_URL=${apiUrl}
NEXT_PUBLIC_SUPABASE_ANON_KEY=${anonKey}
`;

  // Append preserved variables
  const preservedKeys = Object.keys(existingVars);
  if (preservedKeys.length > 0) {
    envContent += '\n# Preserved local configuration\n';
    for (const key of preservedKeys) {
      envContent += `${key}=${existingVars[key]}\n`;
    }
  }

  fs.writeFileSync(envPath, envContent);

  console.log('‚úì Created .env.local with local Supabase credentials');
  console.log(`  API URL: ${apiUrl}`);
  console.log(`  Anon Key: ${anonKey.substring(0, 20)}...`);

  // Create or update supabase/functions/.env.local for Edge Functions
  const functionsEnvPath = path.join(process.cwd(), 'supabase', 'functions', '.env.local');
  const functionsEnvDir = path.dirname(functionsEnvPath);

  // Ensure the directory exists
  if (!fs.existsSync(functionsEnvDir)) {
    fs.mkdirSync(functionsEnvDir, { recursive: true });
  }

  // Preserve existing non-Supabase variables if file exists (like DISCOURSE_*)
  const existingFunctionVars = parseAndPreserveEnvVars(functionsEnvPath, ['SUPABASE_']);

  // Build the functions env content
  let functionsEnvContent = `# Edge Functions Local Configuration
# This file is auto-generated by scripts/setup-local-env.js
#
# ‚ö†Ô∏è  SECURITY WARNING: This file contains the service role key which has
#     full admin access to your database. NEVER commit this file to git.
#     It is already in .gitignore but double-check before committing.
#
# Do not commit this file

# Supabase credentials (auto-populated from local Supabase)
SUPABASE_URL=${apiUrl}
SUPABASE_ANON_KEY=${anonKey}
SUPABASE_SERVICE_ROLE_KEY=${serviceRoleKey}
`;

  // Append preserved variables (like Discourse config)
  const preservedFunctionKeys = Object.keys(existingFunctionVars);
  if (preservedFunctionKeys.length > 0) {
    functionsEnvContent += '\n# Preserved local configuration\n';
    for (const key of preservedFunctionKeys) {
      functionsEnvContent += `${key}=${existingFunctionVars[key]}\n`;
    }
  } else {
    // If no preserved vars, add placeholders from the example
    functionsEnvContent += `
# Discourse API Configuration (optional - only needed for Discourse sync functions)
# DISCOURSE_URL=https://forum.openhamprep.com
# DISCOURSE_API_KEY=your-discourse-api-key-here
# DISCOURSE_USERNAME=your-discourse-admin-username-here
# DISCOURSE_WEBHOOK_SECRET=your-webhook-secret-here
`;
  }

  fs.writeFileSync(functionsEnvPath, functionsEnvContent);

  console.log('‚úì Created supabase/functions/.env.local for Edge Functions');
  console.log(`  Service Role Key: ${serviceRoleKey.substring(0, 20)}...`);
  console.log('\n‚ö†Ô∏è  SECURITY: supabase/functions/.env.local contains the service role key.');
  console.log('   This key has FULL DATABASE ACCESS. Never commit this file to git.');

  console.log('\nüìù To use local Supabase, run: npm run dev:local');
  console.log('üìù To run full stack with functions: npm run dev:full');
  console.log('üìù Or copy .env.local to .env: cp .env.local .env\n');

} catch (error) {
  console.error('‚ùå Error setting up environment:', error.message);
  console.log('\nTry running manually:');
  console.log('  1. supabase status');
  console.log('  2. Copy the API URL and anon key');
  console.log('  3. Create .env.local with those values\n');
  process.exit(1);
}
