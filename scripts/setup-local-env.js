#!/usr/bin/env node

/**
 * This script sets up the .env.local file with credentials from local Supabase
 * Run automatically after `supabase start`
 */

import { execSync } from 'child_process';
import fs from 'fs';
import path from 'path';
import { fileURLToPath } from 'url';

const __filename = fileURLToPath(import.meta.url);
const __dirname = path.dirname(__filename);

console.log('Setting up local environment variables...\n');

try {
  // Get Supabase status
  const statusOutput = execSync('supabase status --output json', { encoding: 'utf-8' });
  // Extract just the JSON object (ignore any warning lines after)
  const jsonMatch = statusOutput.match(/^\{[\s\S]*?\n\}/m);
  if (!jsonMatch) {
    throw new Error('Could not parse Supabase status output');
  }
  const status = JSON.parse(jsonMatch[0]);

  // Get the API URL, anon key, and service role key from the object
  const apiUrl = status.API_URL;
  const anonKey = status.ANON_KEY;
  const serviceRoleKey = status.SERVICE_ROLE_KEY;

  if (!apiUrl || !anonKey) {
    console.error('‚ùå Could not find Supabase API URL or anon key');
    console.log('Make sure Supabase is running: supabase status');
    process.exit(1);
  }

  // Create or update .env.local file
  const envPath = path.join(process.cwd(), '.env.local');

  // Preserve existing non-Supabase variables if file exists
  let existingVars = {};
  if (fs.existsSync(envPath)) {
    const existingContent = fs.readFileSync(envPath, 'utf-8');
    const lines = existingContent.split('\n');
    for (const line of lines) {
      const trimmed = line.trim();
      // Skip comments and empty lines
      if (!trimmed || trimmed.startsWith('#')) continue;
      // Skip Supabase variables (we'll regenerate those)
      if (trimmed.startsWith('NEXT_PUBLIC_SUPABASE_')) continue;
      // Parse and preserve other variables
      const match = trimmed.match(/^([^=]+)=(.*)$/);
      if (match) {
        existingVars[match[1]] = match[2];
      }
    }
  }

  // Build the new content
  let envContent = `# Local Supabase Configuration
# This file is auto-generated by scripts/setup-local-env.js
# Do not commit this file

NEXT_PUBLIC_SUPABASE_URL=${apiUrl}
NEXT_PUBLIC_SUPABASE_ANON_KEY=${anonKey}
`;

  // Append preserved variables
  const preservedKeys = Object.keys(existingVars);
  if (preservedKeys.length > 0) {
    envContent += '\n# Preserved local configuration\n';
    for (const key of preservedKeys) {
      envContent += `${key}=${existingVars[key]}\n`;
    }
  }

  fs.writeFileSync(envPath, envContent);

  console.log('‚úì Created .env.local with local Supabase credentials');
  console.log(`  API URL: ${apiUrl}`);
  console.log(`  Anon Key: ${anonKey.substring(0, 20)}...`);

  // Create or update supabase/functions/.env.local for Edge Functions
  const functionsEnvPath = path.join(process.cwd(), 'supabase', 'functions', '.env.local');
  const functionsEnvDir = path.dirname(functionsEnvPath);

  // Ensure the directory exists
  if (!fs.existsSync(functionsEnvDir)) {
    fs.mkdirSync(functionsEnvDir, { recursive: true });
  }

  // Preserve existing non-Supabase variables if file exists
  let existingFunctionVars = {};
  if (fs.existsSync(functionsEnvPath)) {
    const existingContent = fs.readFileSync(functionsEnvPath, 'utf-8');
    const lines = existingContent.split('\n');
    for (const line of lines) {
      const trimmed = line.trim();
      // Skip comments and empty lines
      if (!trimmed || trimmed.startsWith('#')) continue;
      // Skip Supabase variables (we'll regenerate those)
      if (trimmed.startsWith('SUPABASE_')) continue;
      // Parse and preserve other variables (like DISCOURSE_*)
      const match = trimmed.match(/^([^=]+)=(.*)$/);
      if (match) {
        existingFunctionVars[match[1]] = match[2];
      }
    }
  }

  // Build the functions env content
  let functionsEnvContent = `# Edge Functions Local Configuration
# This file is auto-generated by scripts/setup-local-env.js
# Do not commit this file

# Supabase credentials (auto-populated from local Supabase)
SUPABASE_URL=${apiUrl}
SUPABASE_ANON_KEY=${anonKey}
SUPABASE_SERVICE_ROLE_KEY=${serviceRoleKey || ''}
`;

  // Append preserved variables (like Discourse config)
  const preservedFunctionKeys = Object.keys(existingFunctionVars);
  if (preservedFunctionKeys.length > 0) {
    functionsEnvContent += '\n# Preserved local configuration\n';
    for (const key of preservedFunctionKeys) {
      functionsEnvContent += `${key}=${existingFunctionVars[key]}\n`;
    }
  } else {
    // If no preserved vars, add placeholders from the example
    functionsEnvContent += `
# Discourse API Configuration (optional - only needed for Discourse sync functions)
# DISCOURSE_URL=https://forum.openhamprep.com
# DISCOURSE_API_KEY=your-discourse-api-key-here
# DISCOURSE_USERNAME=your-discourse-admin-username-here
# DISCOURSE_WEBHOOK_SECRET=your-webhook-secret-here
`;
  }

  fs.writeFileSync(functionsEnvPath, functionsEnvContent);

  console.log('‚úì Created supabase/functions/.env.local for Edge Functions');
  if (serviceRoleKey) {
    console.log(`  Service Role Key: ${serviceRoleKey.substring(0, 20)}...`);
  }

  console.log('\nüìù To use local Supabase, run: npm run dev:local');
  console.log('üìù To run full stack with functions: npm run dev:full');
  console.log('üìù Or copy .env.local to .env: cp .env.local .env\n');

} catch (error) {
  console.error('‚ùå Error setting up environment:', error.message);
  console.log('\nTry running manually:');
  console.log('  1. supabase status');
  console.log('  2. Copy the API URL and anon key');
  console.log('  3. Create .env.local with those values\n');
  process.exit(1);
}
