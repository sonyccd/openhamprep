#!/usr/bin/env node

/**
 * This script sets up the .env.local file with credentials from local Supabase
 * Run automatically after `supabase start`
 */

const { execSync } = require('child_process');
const fs = require('fs');
const path = require('path');

console.log('Setting up local environment variables...\n');

try {
  // Get Supabase status
  const status = execSync('supabase status --output json', { encoding: 'utf-8' });
  const services = JSON.parse(status);

  // Find the API URL and anon key
  const apiService = services.find(s => s.name === 'API URL');
  const anonKeyService = services.find(s => s.name === 'anon key');

  if (!apiService || !anonKeyService) {
    console.error('‚ùå Could not find Supabase API URL or anon key');
    console.log('Make sure Supabase is running: supabase status');
    process.exit(1);
  }

  const apiUrl = apiService.value;
  const anonKey = anonKeyService.value;

  // Create .env.local file
  const envContent = `# Local Supabase Configuration
# This file is auto-generated by scripts/setup-local-env.js
# Do not commit this file

VITE_SUPABASE_URL=${apiUrl}
VITE_SUPABASE_PUBLISHABLE_KEY=${anonKey}
VITE_SUPABASE_PROJECT_ID=local
`;

  const envPath = path.join(process.cwd(), '.env.local');
  fs.writeFileSync(envPath, envContent);

  console.log('‚úì Created .env.local with local Supabase credentials');
  console.log(`  API URL: ${apiUrl}`);
  console.log(`  Anon Key: ${anonKey.substring(0, 20)}...`);
  console.log('\nüìù To use local Supabase, run: npm run dev:local');
  console.log('üìù Or copy .env.local to .env: cp .env.local .env\n');

} catch (error) {
  console.error('‚ùå Error setting up environment:', error.message);
  console.log('\nTry running manually:');
  console.log('  1. supabase status');
  console.log('  2. Copy the API URL and anon key');
  console.log('  3. Create .env.local with those values\n');
  process.exit(1);
}
